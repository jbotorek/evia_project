<%= javascript_include_tag 'http://api4.mapy.cz/loader.js' %>
<script type="text/javascript">
Loader.load();
var m;
var center;
var layer;
var trasaLayer;
$(document).ready(function(){
    $("#gpx").hide();
    var center = SMap.Coords.fromWGS84(15.335764, 49.742466);
    m = new SMap(JAK.gel("m"), center, 0);
    m.addDefaultLayer(SMap.DEF_TURIST).enable();
    m.addDefaultControls(); 
    layer = new SMap.Layer.Marker();
    m.addLayer(layer);
    layer.enable();
    trasaLayer = new SMap.Layer.Geometry();
    m.addLayer(trasaLayer).enable();
    var mouse = new SMap.Control.Mouse(SMap.MOUSE_PAN | SMap.MOUSE_WHEEL | SMap.MOUSE_ZOOM);
    m.addControl(mouse);
    load();
    renderMap();
});
var points=[];
function addPoints(){
        $('#points').html('');
        layer.removeAll();
        for(var i=0;i<points.length;i++){
            var marker = new SMap.Marker(points[i][0],"marker"+i,{});
            layer.addMarker(marker);
            if(points.length == 1){
                m.setCenter(points[0][0]);
            }
            var card = new SMap.Card();
            card.getHeader().innerHTML = "<strong>"+points[i][4]+"</strong>";
            card.getBody().innerHTML = "<a href=\"javascript:removePoint('"+i+"')\">odebrat</a>!";
            marker.decorate(SMap.Marker.Feature.Card,card);
            points[i][1]=marker;
            points[i][2]=card;
        }
        layer.redraw();
}
function removePoint(offset){
    m.removeCard();
    points.splice(offset,1);
    renderMap();
}
function getPointsCoords(){
    var coords=[];
    for(var i=0;i<points.length;i++){
        coords.push(points[i][0]);
    }
    return coords;
}

function renderMap(){
    $(document).ready(function(){
        trasaLayer.removeAll();
        addPoints();
        if(points.length>1){
            var route = new SMap.Route(getPointsCoords(), addToMap, {criterion:"bike1"});
        }
        /*var options = {};
        var marker = new SMap.Marker(center, "myMarker", options);
        layer.addMarker(marker);
        var point = SMap.Coords.fromWGS84(16.9654061,49.0);
        var anotherMarker  = new SMap.Marker(point, "another", options);
        layer.addMarker(anotherMarker);
        route = new SMap.Route([center,point], addToMap, {criterion:"bike1"});*/
    });
}
var addToMap = function(route){
    var coords = route.getResults().geometry;
    var cz = m.computeCenterZoom(coords);
    m.setCenterZoom(cz[0], cz[1]);
    var g = new SMap.Geometry(SMap.GEOMETRY_POLYLINE, null, coords);
    trasaLayer.addGeometry(g);
}

function load() { /* Funkce volaná po stisku tlačítka */
    var value = JAK.gel("gpx").value.trim();
    var doc = $.parseXML(value);
    var gpx = $(doc).find("gpx");
    var pointsFromXml = $(gpx).find("trkpt");
    var point=[];
    for(i=0;i<pointsFromXml.length;i++){
        point[0] = SMap.Coords.fromWGS84($(pointsFromXml[i]).attr("lon"),$(pointsFromXml[i]).attr("lat"));
        point[4] = $(pointsFromXml[i]).find("name").text();
        alert(point[0]);
        points.push(point);
        point = [];
    }
    renderMap();
}
</script>
<div id="map" class="detail_field">
    <span class="detail_head">Here is a map of the route:</span><textarea id="gpx"><%= @route.map %></textarea>
    <div id="m" style="height:500px;"> mapa </div>
</div>
<div class="detail_field">
	<span class="detail_head">Description:</span> <%= @route.description %>
</div>
